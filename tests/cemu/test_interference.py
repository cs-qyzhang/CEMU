#!/usr/bin/python3
import subprocess

scheduler = 'rr'
filesize = 8
chunk_sizes = [1,2,4,8,16]
paralle_chunks = [1,2,4,8,16]
kernel_bw = [1,2,4,8]

victim_c = 4
victim_p = 1
victim_b = 4

raw_bw = [['1', '1', '1', '574.773'], ['1', '1', '2', '801.058'], ['1', '1', '4', '1006.21'], ['1', '1', '8', '1061.74'], ['1', '2', '1', '982.587'], ['1', '2', '2', '1521.24'], ['1', '2', '4', '2000.14'], ['1', '2', '8', '2205.33'], ['1', '4', '1', '991.267'], ['1', '4', '2', '1995.1'], ['1', '4', '4', '2780.79'], ['1', '4', '8', '2878.88'], ['1', '8', '1', '998.996'], ['1', '8', '2', '1997.84'], ['1', '8', '4', '3012.84'], ['1', '8', '8', '3025.84'], ['1', '16', '1', '999.17'], ['1', '16', '2', '1997.76'], ['1', '16', '4', '3093.29'], ['1', '16', '8', '3094.6'], ['2', '1', '1', '621.393'], ['2', '1', '2', '923.926'], ['2', '1', '4', '1172.17'], ['2', '1', '8', '1358.04'], ['2', '2', '1', '988.245'], ['2', '2', '2', '1824.8'], ['2', '2', '4', '2294.43'], ['2', '2', '8', '2584.56'], ['2', '4', '1', '998.523'], ['2', '4', '2', '1997.36'], ['2', '4', '4', '2992.12'], ['2', '4', '8', '3009.89'], ['2', '8', '1', '997.988'], ['2', '8', '2', '1997.26'], ['2', '8', '4', '3085.63'], ['2', '8', '8', '3090.9'], ['2', '16', '1', '998.461'], ['2', '16', '2', '1996.94'], ['2', '16', '4', '3114.75'], ['2', '16', '8', '3115.8'], ['4', '1', '1', '652.622'], ['4', '1', '2', '998.103'], ['4', '1', '4', '1326.09'], ['4', '1', '8', '1597.5'], ['4', '2', '1', '996.05'], ['4', '2', '2', '1933.72'], ['4', '2', '4', '2624.19'], ['4', '2', '8', '2878.77'], ['4', '4', '1', '997.707'], ['4', '4', '2', '1995.55'], ['4', '4', '4', '3061.01'], ['4', '4', '8', '3075.15'], ['4', '8', '1', '996.701'], ['4', '8', '2', '1985.92'], ['4', '8', '4', '3111.66'], ['4', '8', '8', '3112.79'], ['4', '16', '1', '997.741'], ['4', '16', '2', '1961.04'], ['4', '16', '4', '3112.13'], ['4', '16', '8', '3114.35'], ['8', '1', '1', '683.808'], ['8', '1', '2', '1065.67'], ['8', '1', '4', '1418.04'], ['8', '1', '8', '1719.45'], ['8', '2', '1', '996.081'], ['8', '2', '2', '1976.64'], ['8', '2', '4', '2773.76'], ['8', '2', '8', '2987.43'], ['8', '4', '1', '996.3'], ['8', '4', '2', '1991.96'], ['8', '4', '4', '3099.2'], ['8', '4', '8', '3104.6'], ['8', '8', '1', '995.568'], ['8', '8', '2', '1978.43'], ['8', '8', '4', '3108.28'], ['8', '8', '8', '3111.58'], ['8', '16', '1', '995.708'], ['8', '16', '2', '1911.1'], ['8', '16', '4', '3108.25'], ['8', '16', '8', '3113.96'], ['16', '1', '1', '697.254'], ['16', '1', '2', '1096.32'], ['16', '1', '4', '1476.78'], ['16', '1', '8', '1815.61'], ['16', '2', '1', '988.351'], ['16', '2', '2', '1984.46'], ['16', '2', '4', '2932.94'], ['16', '2', '8', '3061.16'], ['16', '4', '1', '993.367'], ['16', '4', '2', '1978.34'], ['16', '4', '4', '3101.49'], ['16', '4', '8', '3105.25'], ['16', '8', '1', '992.643'], ['16', '8', '2', '1902.62'], ['16', '8', '4', '3101.07'], ['16', '8', '8', '3101.11'], ['16', '16', '1', '987.972'], ['16', '16', '2', '1784.91'], ['16', '16', '4', '3099.21'], ['16', '16', '8', '3043.65']]
victim_bw = 1326;

cmdline_victim = f'./test_parallel_chunks_threads -s {filesize} -c {victim_c} -p {victim_p} -b {victim_b} -g 1 -r 6 -i {victim_bw}'
cmd_victim = cmdline_victim.split(' ')
for c in chunk_sizes:
    for p in paralle_chunks:
        for b in kernel_bw:
            cmd_bw = 0
            for bw in raw_bw:
                if bw[0] == str(c) and bw[1] == str(p) and bw[2] == str(b):
                    cmd_bw = int(float(bw[3]))
            cmdline = f'./test_parallel_chunks_threads -s {filesize} -c {c} -p {p} -b {b} -g 2 -r 6 -i {cmd_bw}'
            cmd = cmdline.split(' ')
            proc1 = subprocess.Popen(cmd_victim, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            proc2 = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            output1, error1 = proc1.communicate()
            output2, error2 = proc2.communicate()
            output1 = output1.decode("utf-8")
            output2 = output2.decode("utf-8")
            error1 = error1.decode("utf-8")
            error2 = error2.decode("utf-8")
            lat_victim = output1.split('\n')[-2].split(' ')[-1][:-2]
            lat_another = output2.split('\n')[-2].split(' ')[-1][:-2]

            print(f'{c},{p},{b},{lat_victim},{lat_another}')